{
  "id": "RacfTn3270",
  "BackEnd": "Scriptable",

  "CheckSystem": {
    "Parameters": [
      { "Address": { "Type": "String", "Required": true } },
      { "AssetName": { "Type": "String", "Required": false, "DefaultValue": "" } },
      { "FuncUserName": { "Type": "String", "Required": true } },
      { "FuncPassword": { "Type": "Secret", "Required": true } },
      { "Port": { "Type": "Integer", "Required": false, "DefaultValue": 23 } },
      { "Timeout": { "Type": "Integer", "Required": false, "DefaultValue": 30 } },
      { "UseSsl": { "Type": "boolean", "Required": false, "DefaultValue": true } },
      { "SkipServerCertValidation": { "Type": "boolean", "Required": false, "DefaultValue": false } },
      { "WorkstationId": { "Type": "String", "Required": false, "DefaultValue": "" } }
    ],
    "Do": [
      { "Function": { "Name": "LoginFuncRacf", "ResultVariable": "LoginResult" }, "Parameters": ["%FuncUserName%"] },
      { "Condition": {
          "If": "!LoginResult",
          "Then": {
            "Do": [ { "Return": { "Value": "False" } } ]
          }
        }
      },
      {
        "Status": {
          "Type": "Checking",
          "Message": {
            "Name": "AssetTestingConnection",
            "Parameters": ["%Address%"]
          },
          "Percent": "50"
        }
      },
      { "Send": { "ConnectionObjectName": "Tn3270Connection", "Buffer": "LU\n\f" } },
      { "Receive": { "ConnectionObjectName": "Tn3270Connection", "BufferName": "LuCmdBuffer" } },
      {
        "Condition": {
          "If": "Regex.IsMatch(LuCmdBuffer, $\"^(.*USER={FuncUserName}.*)\")",
          "Then": {
            "Do": [
              {
                "Status": {
                  "Type": "Checking",
                  "Message": {
                    "Name": "InsufficientPrivilegesAccessPassword"
                  },
                  "Percent": "95"
                }
              },
              { "Function": { "Name": "LogoutRacf" } },
              { "Return": { "Value": "false" } }
            ]
          },
          "Else": {
            "Do": [
              { "Function": { "Name": "LogoutRacf" } },
              { "Return": { "Value": "true" } }
            ]
          }
        }
      }
    ]
  },

  "CheckPassword": {
    "Parameters": [
      { "Address": { "Type": "String", "Required": true } }, 
      { "AssetName": { "Type": "String", "Required": false, "DefaultValue": "" } },
      { "FuncUserName": { "Type": "String", "Required": true } },
      { "FuncPassword": { "Type": "Secret", "Required": true } },
      { "AccountUserName": { "Type": "String", "Required": true } },
      { "AccountPassword": { "Type": "Secret", "Required": true } },
      { "Port": { "Type": "Integer", "Required": false, "DefaultValue": 23 } },
      { "Timeout": { "Type": "Integer", "Required": false, "DefaultValue": 30 } },
      { "UseSsl": { "Type": "boolean", "Required": false, "DefaultValue": true } },
      { "SkipServerCertValidation": { "Type": "boolean", "Required": false, "DefaultValue": false } },
      { "WorkstationId": { "Type": "String", "Required": false, "DefaultValue": "" } }
    ],
    "Do": [
      { "Status": { "Type": "Checking", "Percent": 20, "Message": { "Name": "VerifyingPassword" } } },
      { "Function": { "Name": "LoginFuncRacf", "ResultVariable": "LoginResult" }, "Parameters": [ "%{ FuncUserName.ToUpper() }%" ]  },
      { "Condition": { "If": "!LoginResult", "Then": { "Do": [ { "Throw": { "Value": "Account %FuncUserName% not found" } } ] } } },
      { "Function": { "Name": "LogoutRacf" } },
      { "Function": { "Name": "LoginUserRacf", "ResultVariable": "LoginResult" },  "Parameters": [ "%{ AccountUserName.ToUpper() }%" ] },
      { "Condition": { "If": "!LoginResult", "Then": { "Do": [ { "Return": { "Value": "False" } } ] } } },
      { "Function": { "Name": "LogoutRacf" } },
      { "Return": { "Value": true } }
    ]
  },

  "ChangePassword": {
    "Parameters": [
      { "Address": { "Type": "String", "Required": true } },
      { "AssetName": { "Type": "String", "Required": false, "DefaultValue": "" } },
      { "FuncUserName": { "Type": "String", "Required": true } },
      { "FuncPassword": { "Type": "Secret", "Required": true } },
      { "AccountUserName": { "Type": "String", "Required": true } },
      { "NewPassword": { "Type": "Secret", "Required": true } },
      { "Port": { "Type": "Integer", "Required": false, "DefaultValue": 23 } },
      { "Timeout": { "Type": "Integer", "Required": false, "DefaultValue": 30 } },
      { "UseSsl": { "Type": "boolean", "Required": false, "DefaultValue": true } },
      { "SkipServerCertValidation": { "Type": "boolean", "Required": false, "DefaultValue": false } },
      { "WorkstationId": { "Type": "String", "Required": false, "DefaultValue": "" } }
    ],
    "Do": [
      { "SetItem": { "Name": "FuncUserName", "Value": "%{ FuncUserName.ToUpper() }%" } },
      { "SetItem": { "Name": "AccountUserName", "Value": "%{ AccountUserName.ToUpper() }%" } },
      { "Function": { "Name": "LoginFuncRacf", "ResultVariable": "LoginResult" } },
      { "Condition": { "If": "!LoginResult", "Then": { "Do": [ { "Return": { "Value": "False" } } ] } } },
      { "Status": {
          "Type": "Changing",
          "Message": {"Name": "ChangingPassword",
            "Parameters": [ "%AccountUserName%" ] },
          "Percent": "50"
        }
      },
      { "Send": { "ConnectionObjectName": "Tn3270Connection", "Buffer": "ALU %AccountUserName% PASSWORD(%NewPassword%) NOEXPIRED\n\f","ContainsSecret": true } },
      { "Receive": { "ConnectionObjectName": "Tn3270Connection", "BufferName": "AluCmdBuffer", "ContainsSecret": true } },
      { "SetItem": { "Name": "Global:PwdChangeResult", "Value": "false" } },
      { "SetItem": { "Name": "Global:InvalidPassword", "Value": false } },
      {
        "Condition": {
          "If": "Regex.IsMatch(AluCmdBuffer,@\"(.*READY[ \n]*$)\")",
          "Then": {
            "Do": [ { "SetItem": { "Name": "PwdChangeResult", "Value": true } } ]
          },
          "Else": {
            "Do": [
              { "Function": { "Name": "LogoutRacf" } },
              { "SetItem": { "Name": "PwdChangeResult", "Value": true } }
            ]
          }
        }
      },
      { "Return": { "Value": "%PwdChangeResult%" } }
    ]
  },


  "Functions": [
          {
            "Name": "LoginFuncRacf",
            "Do": [
              {
                "Function": {
                  "Name": "ConnectTn3270",
                  "ResultVariable": "ConnectResult",
                  "Parameters": [
                    "%FuncUserName%"
                  ]
                }
              },
              {
                "Status": {
                  "Type": "Checking",
                  "Percent": 40,
                  "Message": {
                    "Name": "SystemLoginCheck",
                    "Parameters": [ "%Address%" ]
                  }
                }
              },
              {
                "Send": {
                  "ConnectionObjectName": "Tn3270Connection",
                  "Buffer": "LOGON %FuncUserName%\n\f"
                }
              },
              {
                "Receive": {
                  "ConnectionObjectName": "Tn3270Connection",
                  "BufferName": "LoginCheckBuffer"
                }
              },
              {
                "Condition": {
                  "If": "Regex.IsMatch(LoginCheckBuffer,@\".*TSO/E LOGON.*\")",
                  "Then": {
                    "Do": [
                      {
                        "Send": {
                          "ConnectionObjectName": "Tn3270Connection",
                          "Buffer": "%FuncPassword%\n\f",
                          "ContainsSecret": true
                        }
                      },
                      {
                        "Receive": {
                          "ConnectionObjectName": "Tn3270Connection",
                          "BufferName": "LoginCheckBuffer"
                        }
                      },
                      {
                        "Condition": {
                          "If": "Regex.IsMatch(LoginCheckBuffer, @\"(.*LAST ACCESS AT.*)|(.*%FuncUserName%.*LOGON IN PROGRESS.*)\")",
                          "Then": {
                            "Do": [ { "Return": { "Value": true } } ]
                          },
                          "Else": {
                            "Do": [
                              {
                                "Status": {
                                  "Type": "Checking",
                                  "Percent": 95,
                                  "Message": {
                                    "Name": "FuncAccountLoginFailed",
                                    "Parameters": [ "%FuncUserName%" ]
                                  }
                                }
                              },
                              { "Function": { "Name": "LogoutRacf" } },
                              { "Return": { "Value": false } }
                            ]
                          }
                        }
                      }
                    ]
                  },
                  "Else": {
                    "Do": [
                      {
                        "Status": {
                          "Type": "Checking",
                          "Percent": 95,
                          "Message": {
                            "Name": "FuncAccountLoginFailed",
                            "Parameters": [ "%FuncUserName%" ]
                          }
                        }
                      },
                      { "Function": { "Name": "LogoutRacf" } },
                      { "Return": { "Value": false } }
                    ]
                  }
                }
              }
            ]
          },
          {
            "Name": "LoginUserRacf",
            "Do": [
              {
                "Function": {
                  "Name": "ConnectTn3270",
                  "ResultVariable": "ConnectResult",
                  "Parameters": [
                    "%AccountUserName%"
                  ]
                }
              },
              {
                "Status": {
                  "Type": "Checking",
                  "Percent": 40,
                  "Message": {
                    "Name": "SystemLoginCheck",
                    "Parameters": [ "%Address%" ]
                  }
                }
              },
              {
                "Send": {
                  "ConnectionObjectName": "Tn3270Connection",
                  "Buffer": "LOGON %AccountUserName%\n\f"
                }
              },
              {
                "Receive": {
                  "ConnectionObjectName": "Tn3270Connection",
                  "BufferName": "LoginCheckBuffer"
                }
              },
              {
                "Condition": {
                  "If": "Regex.IsMatch(LoginCheckBuffer,@\".*TSO/E LOGON.*\")",
                  "Then": {
                    "Do": [
                      {
                        "Send": {
                          "ConnectionObjectName": "Tn3270Connection",
                          "Buffer": "%AccountPassword%\n\f",
                          "ContainsSecret": true
                        }
                      },
                      {
                        "Receive": {
                          "ConnectionObjectName": "Tn3270Connection",
                          "BufferName": "LoginCheckBuffer"
                        }
                      },
                      {
                        "Condition": {
                          "If": "Regex.IsMatch(LoginCheckBuffer, @\"(.*LAST ACCESS AT.*)|(.*%AccountUserName%.*LOGON IN PROGRESS.*)\")",
                          "Then": {
                            "Do": [ { "Return": { "Value": true } }
                            ]
                          },
                          "Else": {
                            "Do": [
                              {
                                "Status": {
                                  "Type": "Checking",
                                  "Percent": 95,
                                  "Message": {
                                    "Name": "AccountLoginFailed",
                                    "Parameters": [ "%AccountUserName%" ]
                                  }
                                }
                              },
                              { "Function": { "Name": "LogoutRacf" } },
                              { "Return": { "Value": false } }
                            ]
                          }
                        }
                      }
                    ]
                  },
                  "Else": {
                    "Do": [
                      {
                        "Status": {
                          "Type": "Checking",
                          "Percent": 95,
                          "Message": {
                            "Name": "FuncAccountLoginFailed",
                            "Parameters": [ "%AccountUserName%" ]
                          }
                        }
                      },
                      { "Function": { "Name": "LogoutRacf" } },
                      { "Return": { "Value": false } }
                    ]
                  }
                }
              }
            ]
          },
          {
            "Name": "ConnectTn3270",
            "Parameters": [
              {
                "LoginUserName": {
                  "Type": "String",
                  "Required": true
                }
              }
            ],
            "Do": [
              {
                "Status": {
                  "Type": "Connecting",
                  "Percent": 30,
                  "Message": {
                    "Name": "AssetConnectingWithAddress",
                    "Parameters": [ "%AssetName%", "%Address%" ]
                  }
                }
              },
              {
                "Try": {
                  "Do": [
                    {
                      "Connect": {
                        "ConnectionObjectName": "GLOBAL:Tn3270Connection",
                        "Type": "Tn3270",
                        "Port": "%Port::$%",
                        "NetworkAddress": "%Address%",
                        "Login": "%LoginUserName%",
                        "Timeout": "%Timeout%",
                        "WorkstationId": "%WorkstationId::$%",
                        "UseSsl": "%UseSsl%",
                        "SkipServerCertValidation": "%SkipServerCertValidation%"
                      }
                    }
                  ],
                  "Catch": [
                    {
                      "Condition": {
                        "If": "string.IsNullOrEmpty(Exception)",
                        "Then": {
                          "Do": [
                            {
                              "Status": {
                                "Type": "Connecting",
                                "Percent": 95,
                                "Message": {
                                  "Name": "AssetConnectFailedWithAddress",
                                  "Parameters": [ "%AssetName%", "%Address%" ]
                                }
                              }
                            }
                          ]
                        },
                        "Else": {
                          "Do": [
                            {
                              "Status": {
                                "Type": "Connecting",
                                "Percent": 95,
                                "Message": {
                                  "Name": "AssetConnectFailedWithReasonAndAddress",
                                  "Parameters": [ "%AssetName%", "%Address%", "%Exception%" ]
                                }
                              }
                            }
                          ]
                        }
                      }
                    },
                    { "Throw": { "Value": "Tn3270 Connection Error" } }
                  ]
                }
              },
              { "Return": { "Value": true } }
            ]
          },
          {
            "Name": "LogoutRacf",
            "Do": [
              {
                "Try": {
                  "Do": [
                    {
                      "Send": {
                        "ConnectionObjectName": "Tn3270Connection",
                        "Buffer": "LOGOFF\n\f"
                      }
                    },
                    { "Disconnect": { "ConnectionObjectName": "Tn3270Connection" } }
                  ],
                  "Catch": [ { "Comment": { "Text": "Ignore exceptions logging out" } } ]
                }
              },
              { "Return": { "Value": true } }
            ]
          }
        ]
      }

